<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Futsal League Sydney</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { text-align:center; padding:16px 0; background:#222; color:#fff; font-size:24px; }
    .wrap { max-width:1200px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: 280px 1fr; gap:20px; }
    .card { background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.08); padding:16px; }
    h2 { margin:0 0 12px; font-size:20px; }
    label { display:block; font-weight:600; margin:10px 0 4px; }
    input { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    button { margin-top:12px; padding:10px 14px; border:0; border-radius:6px; background:#0d6efd; color:#fff; cursor:pointer; }
    button:hover { background:#0b5ed7; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px 10px; text-align:left; white-space:nowrap; }
    th { background:#f5f5f5; position:sticky; top:0; z-index:1; }
    .actions { text-align:right; }
    .btn-danger { background:#e74c3c; }
    .btn-danger:hover { background:#c0392b; }
    .muted { color:#666; font-size:13px; margin-bottom:8px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>Futsal League Sydney</header>

  <div class="wrap">
    <div class="grid">
      <!-- Form -->
      <div class="card">
        <h2>Match Results</h2>
        <form id="matchForm">
          <label>League</label>
          <input type="text" name="League" value="Heffron" required>
          <label>Date</label>
          <input type="date" name="Date" id="date" required>
          <label>Round</label>
          <input type="text" name="Round" required>
          <label>Home Team</label>
          <input type="text" name="Home Team" value="Kairat Sydney FC" required>
          <label>Away Team</label>
          <input type="text" name="Away Team" required>
          <label>Home Goals</label>
          <input type="number" name="Home Goals" value="0" required>
          <label>Away Goals</label>
          <input type="number" name="Away Goals" value="0" required>

          <button type="submit">Submit Match</button>
          <div class="muted" id="formStatus"></div>
        </form>
      </div>

      <!-- Tabela -->
      <div class="card">
        <h2>Existing Matches</h2>
        <div class="muted">Source: <code>match-results</code> (Google Sheets)</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Round</th>
                <th>Home Team</th>
                <th>Away Team</th>
                <th>Home Goals</th>
                <th>Away Goals</th>
                <th>League</th>
                <th>Registration Date</th>
                <th class="actions">Actions</th>
              </tr>
            </thead>
            <tbody id="matchesBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  /* CONFIG */
  const ENDPOINT_MATCHES = 'COLE_AQUI_A_WEB_APP_URL'; // <--- troque
  const TOKEN = 'SEU_TOKEN_FORTE_AQUI';               // <--- igual ao Apps Script

  /* Helpers */
  const qs = (sel, el=document) => el.querySelector(sel);

  function fmtNum(v){
    // garante que números não virem datas
    if (v === null || v === undefined || v === '') return '';
    const n = Number(v);
    return Number.isFinite(n) ? String(n) : String(v);
  }
  function fmtDateCell(v){
    // Mostra como vem da planilha (string) — sem “converter para Date”
    return (v === null || v === undefined) ? '' : String(v);
  }

  /* Carregar tabela */
  async function loadMatches(){
    const tbody = qs('#matchesBody');
    tbody.innerHTML = '<tr><td colspan="9">Loading…</td></tr>';
    try{
      const resp = await fetch(ENDPOINT_MATCHES, { method:'GET' });
      const json = await resp.json();
      if (!json.ok) throw new Error(json.error || 'Erro ao obter dados');

      const headers = json.headers || [];
      const recs = json.records || [];

      // Mapeia índices por nome (para não depender da ordem)
      const idx = name => headers.indexOf(name);

      const iDate   = idx('Date');
      const iRound  = idx('Round');
      const iHomeT  = idx('Home Team');
      const iAwayT  = idx('Away Team');
      const iHG     = idx('Home Goals');
      const iAG     = idx('Away Goals');
      const iLeague = idx('League');
      const iReg    = idx('Registration Date');

      tbody.innerHTML = '';
      recs.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDateCell(r['Date'])}</td>
          <td>${fmtDateCell(r['Round'])}</td>
          <td>${fmtDateCell(r['Home Team'])}</td>
          <td>${fmtDateCell(r['Away Team'])}</td>
          <td>${fmtNum(r['Home Goals'])}</td>
          <td>${fmtNum(r['Away Goals'])}</td>
          <td>${fmtDateCell(r['League'])}</td>
          <td>${fmtDateCell(r['Registration Date'])}</td>
          <td class="actions">
            <button class="btn-danger" onclick="deleteMatch(${r.rowNumber})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (!recs.length){
        tbody.innerHTML = '<tr><td colspan="9">No data</td></tr>';
      }
    } catch(err){
      console.error(err);
      qs('#matchesBody').innerHTML = `<tr><td colspan="9">Failed to load data</td></tr>`;
    }
  }

  /* Deletar */
  async function deleteMatch(rowNumber){
    if (!confirm('Delete this match?')) return;
    try{
      const body = new URLSearchParams({
        action: 'delete',
        token: TOKEN,
        row: String(rowNumber)
      });
      const resp = await fetch(ENDPOINT_MATCHES, { method:'POST', body });
      const json = await resp.json();
      if (!json.ok) throw new Error(json.error || 'Falha ao deletar');
      await loadMatches();
    } catch(err){
      alert('Erro: ' + err.message);
      console.error(err);
    }
  }
  window.deleteMatch = deleteMatch;

  /* Submit do formulário (inserir) */
  qs('#matchForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const form = ev.target;
    const data = Object.fromEntries(new FormData(form).entries());
    const body = new URLSearchParams({
      action: 'add',
      token: TOKEN,
      ...data
    });
    const status = qs('#formStatus');
    try{
      status.textContent = 'Sending…';
      const resp = await fetch(ENDPOINT_MATCHES, { method:'POST', body });
      const json = await resp.json();
      if (!json.ok) throw new Error(json.error || 'Falha ao enviar');
      status.textContent = 'Saved!';
      form.reset();
      // defaults
      qs('[name="League"]').value = 'Heffron';
      qs('[name="Home Team"]').value = 'Kairat Sydney FC';
      qs('[name="Home Goals"]').value = 0;
      qs('[name="Away Goals"]').value = 0;
      // volta data para hoje
      const today = new Date().toISOString().split('T')[0];
      qs('#date').value = today;

      await loadMatches();
    } catch(err){
      status.textContent = 'Error: ' + err.message;
      console.error(err);
    } finally {
      setTimeout(()=> status.textContent = '', 3000);
    }
  });

  /* Inicialização */
  document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    qs('#date').value = today;
    loadMatches();
  });
</script>
</body>
</html>
